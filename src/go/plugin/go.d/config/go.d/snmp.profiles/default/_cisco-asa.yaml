# Profile for Cisco ASA devices
extends:
  - _cisco-generic.yaml

metrics:
  - MIB: CISCO-FIREWALL-MIB
    table:
      OID: 1.3.6.1.4.1.9.9.147.1.2.2.2
      name: cfwConnectionStatTable
    symbols:
      - OID: 1.3.6.1.4.1.9.9.147.1.2.2.2.1.5
        name: cfwConnectionStatValue
        description: Current status of the resource statistic
        unit: "{connection}"
        family: Connections
    metric_tags:
      - index: 1
        tag: service_type
        mapping:
          1: otherFWService
          2: fileXferFtp
          3: fileXferTftp
          4: fileXferFtps
          5: loginTelnet
          6: loginRlogin
          7: loginTelnets
          8: remoteExecSunRPC
          9: remoteExecMSRPC
          10: remoteExecRsh
          11: remoteExecXserver
          12: webHttp
          13: webHttps
          14: mailSmtp
          15: multimediaStreamworks
          16: multimediaH323
          17: multimediaNetShow
          18: multimediaVDOLive
          19: multimediaRealAV
          20: multimediaRTSP
          21: dbOracle
          22: dbMSsql
          23: contInspProgLang
          24: contInspUrl
          25: directoryNis
          26: directoryDns
          27: directoryNetbiosns
          28: directoryNetbiosdgm
          29: directoryNetbiosssn
          30: directoryWins
          31: qryWhois
          32: qryFinger
          33: qryIdent
          34: fsNfsStatus
          35: fsNfs
          36: fsCifs
          37: protoIcmp
          38: protoTcp
          39: protoUdp
          40: protoIp
          41: protoSnmp
      - index: 2
        tag: stat_type
        mapping:
          1: other
          2: totalOpen         # Total number of connections opened since system startup
          3: currentOpen       # Current number of open connections
          4: currentClosing    # Current number of connections in the process of closing
          5: currentHalfOpen   # Current number of half-open connections (e.g. TCP SYN received)
          6: currentInUse      # Current number of connections in use by the firewall
          7: high              # Highest number of connections in use since system startup

  - MIB: CISCO-REMOTE-ACCESS-MONITOR-MIB
    symbol:
      # declined sessions
      OID: 1.3.6.1.4.1.9.9.392.1.4.1.2.0
      name: crasNumDeclinedSessions
      description: Number of session setup attempts declined due to authentication or authorization failure
      unit: "{session}/s"
      family: Sessions
  - MIB: CISCO-REMOTE-ACCESS-MONITOR-MIB
    symbol:
      # num sessions
      OID: 1.3.6.1.4.1.9.9.392.1.3.1.0
      name: crasNumSessions
      description: Number of currently active sessions
      unit: "{session}"
      family: Sessions
  - MIB: CISCO-REMOTE-ACCESS-MONITOR-MIB
    symbol:
      # num users
      OID: 1.3.6.1.4.1.9.9.392.1.3.3.0
      name: crasNumUsers
      description: Number of users who have active sessions
      unit: "{user}"
      family: Users
  - MIB: CISCO-REMOTE-ACCESS-MONITOR-MIB
    metric_type: monotonic_count
    symbol:
      # session setup failed
      OID: 1.3.6.1.4.1.9.9.392.1.4.1.3.0
      name: crasNumSetupFailInsufResources
      description: Number of session setup attempts failed due to insufficient resources
      unit: "{failure}/s"
      family: Sessions
  - MIB: CISCO-IPSEC-FLOW-MONITOR-MIB
    symbol:
      OID: 1.3.6.1.4.1.9.9.171.1.3.1.1.0
      name: cipSecGlobalActiveTunnels
      description: Number of currently active IPsec Phase-2 Tunnels
      family: IPsec/Tunnels/Phase-2
      unit: "{tunnel}"
  - MIB: CISCO-IPSEC-FLOW-MONITOR-MIB
    metric_type: monotonic_count
    symbol:
      OID: 1.3.6.1.4.1.9.9.171.1.3.1.4.0
      name: cipSecGlobalHcInOctets
      description: High capacity count of total octets received by all current and previous IPsec Phase-2 Tunnels
      family: IPsec/Tunnels/Phase-2
      unit: "By/s"
  - MIB: CISCO-IPSEC-FLOW-MONITOR-MIB
    metric_type: monotonic_count
    symbol:
      OID: 1.3.6.1.4.1.9.9.171.1.3.1.17.0
      name: cipSecGlobalHcOutOctets
      description: High capacity count of total octets sent by all current and previous IPsec Phase-2 Tunnels
      family: IPsec/Tunnels/Phase-2
      unit: "By/s"
  - MIB: ENTITY-SENSOR-MIB
    table:
      OID: 1.3.6.1.2.1.99.1.1
      name: entPhySensorTable
    symbols:
      - OID: 1.3.6.1.2.1.99.1.1.1.4
        name: entPhySensorValue
        description: Most recent measurement obtained by the agent for this sensor
        unit: "1"
        family: Sensors
        transform: |
          {{- $sensorType := index .Metric.Tags "sensor_type" | default "" -}}
          {{- $sensorScale := index .Metric.Tags "sensor_scale" | default "" -}}
          {{- $sensorPrecision := index .Metric.Tags "sensor_precision" | default "0" -}}

          {{- $config := get (dict
              "1" (dict "name" "unspecified" "family" "Generic" 
                   "desc" "Unspecified or vendor-specific sensor")
              "2" (dict "name" "unknown" "family" "Generic"
                   "desc" "Unknown sensor type")
              "3" (dict "name" "voltage_ac" "unit" "volts" "family" "Power" 
                   "desc" "AC voltage")
              "4" (dict "name" "voltage_dc" "unit" "volts" "family" "Power" 
                   "desc" "DC voltage")
              "5" (dict "name" "current" "unit" "amperes" "family" "Power" 
                   "desc" "Current draw")
              "6" (dict "name" "power" "unit" "watts" "family" "Power" 
                   "desc" "Power consumption")
              "7" (dict "name" "frequency" "unit" "hertz" "family" "Power" 
                   "desc" "Frequency")
              "8" (dict "name" "temperature" "unit" "celsius" "family" "Temperature" 
                   "desc" "Temperature reading")
              "9" (dict "name" "humidity" "unit" "percentage" "family" "Environment" 
                   "desc" "Relative humidity")
              "10" (dict "name" "fan_speed" "unit" "rpm" "family" "Fan" 
                   "desc" "Fan rotation speed")
              "11" (dict "name" "airflow" "unit" "cmm" "family" "Environment" 
                   "desc" "Airflow in cubic meters per minute")
              "12" (dict "name" "sensor_state" "family" "Status" 
                    "mapping" (i64map 0 "false" 1 "true" 2 "true") 
                    "desc" "Boolean sensor state")
          ) $sensorType -}}

          {{- $scaleMap := dict
              "1" 1.0     "2" 0.001   "3" 0.000001 "4" 0.000000001
              "5" 0.000000000001     "6" 0.000000000000001
              "7" 0.000000000000000001 "8" 0.000000000000000000001
              "9" 0.000000000000000000000001 "10" 0.1
              "11" 0.01   "12" 1000.0 "13" 1000000.0 "14" 1000000000.0
          -}}
          {{- $scale := float64 (get $scaleMap $sensorScale | default 1.0) -}}
          {{- $precision := int $sensorPrecision -}}

          {{- if $config -}}
            {{- setName .Metric (printf "%s_%s" .Metric.Name (get $config "name")) -}}
            {{- setFamily .Metric (printf "Sensors/%s" (get $config "family")) -}}
            {{- with get $config "desc" -}}{{- setDesc $.Metric . -}}{{- end -}}
            {{- with get $config "unit" -}}{{- setUnit $.Metric . -}}{{- end -}}
            {{- with get $config "mapping" -}}{{- setMappings $.Metric . -}}{{- end -}}

            {{- if not (hasKey $config "mapping") -}}
              {{- $scaled := mul (float64 .Metric.Value) $scale -}}
              {{- if gt $precision 0 -}}
                {{- $scaled = div $scaled (pow 10 $precision) -}}
              {{- end -}}
              {{- setValue .Metric (int64 $scaled) -}}
            {{- end -}}
          {{- end -}}

          {{- deleteTag .Metric "sensor_type" -}}
          {{- deleteTag .Metric "sensor_scale" -}}
          {{- deleteTag .Metric "sensor_precision" -}}
    metric_tags:
      - symbol:
          OID: 1.3.6.1.2.1.99.1.1.1.1
          name: entPhySensorType
        tag: sensor_type
      - symbol:
          OID: 1.3.6.1.2.1.99.1.1.1.2
          name: entPhySensorScale
        tag: sensor_scale
      - symbol:
          OID: 1.3.6.1.2.1.99.1.1.1.6
          name: entPhySensorUnitsDisplay
        tag: _sensor_desc
      - index: 1
        tag: sensor_id
